<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>NS2 Server Browser</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/js/cookies.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <script>
        var instance = null;

        function getFlagEmoji(countryCode) {
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        function alpineInstance() {
            return {
                title: 'NS2 Server Browser',
                heartbeat: true,
                hideEmpty: true,
                soundEnabled: true,
                favoritesOnTop: true,
                sortKey: 'id',
                sortInverse: false,
                showPing: false,
                connected: false,
                servers: [],
                getServers() {
                    fetch('/servers')
                        .then(response => response.json())
                        .then(data => {
                            // Loop over servers
                            data.forEach((newserver) => {
                                // If server already in local list, update fields one by one
                                let server = this.servers.find(v => v.id == newserver.id);
                                if (server) {
                                    for (let key in newserver) {
                                        if (server[key] !== newserver[key]) {
                                            server[key] = newserver[key];
                                        }
                                    }
                                } else {
                                    // Else add this new server to the local list
                                    newserver.favorite = this.isFavorite(newserver);
                                    this.servers.push(newserver);
                                }
                            });
                            // Do a loop on local list to prune removed servers
                            this.servers = this.servers.filter(server => data.find(v => v.id == server.id) !== null)

                            this.heartbeat = !this.heartbeat;
                        });

                },
                sendKeepAlive() {
                    socket.send("ping");
                },
                connectWebsocket() {
                    var webSocketProtocol = location.protocol == "https:" ? "wss:" : "ws:";
                    var webSocketURI = webSocketProtocol + "//" + location.host + "/ws";

                    socket = new WebSocket(webSocketURI);

                    socket.onopen = function () {
                        console.log("WebSocket connected.");
                        window.instance.connected = true;
                    };

                    socket.onclose = function (event) {
                        if (event.wasClean) {
                            console.log('WebSocket disconnected.');
                        } else {
                            console.log('WebSocket connection lost.'); // for example if server processes is killed
                        }
                        window.instance.connected = false;
                        console.log('Code: ' + event.code + '. Reason: ' + event.reason);

                        console.log('Reconnecting in 5 seconds...');
                        window.instance.getServers(); // Grab fresh server list now since the websocket connection only receives delta updates
                        setTimeout(() => { window.instance.connectWebsocket() }, 5000);
                    };

                    socket.onmessage = function (event) {
                        //console.log("Data received: " + event.data);
                        let data = JSON.parse(event.data);
                        for (let i = 0; i < data.length; i++) {
                            // Copy each field if it has changed
                            let server = window.instance.servers.find(v => v.id == data[i].id);
                            if (server) {
                                // Update existing server
                                for (let key in data[i]) {
                                    if (server[key] !== data[i][key]) {
                                        server[key] = data[i][key];
                                    }
                                }
                            } else {
                                // Add server
                                window.instance.servers.push(data[i]);
                            }
                        }

                        window.instance.heartbeat = !window.instance.heartbeat;

                    };

                    socket.onerror = function (error) {
                        console.log("Error: " + error.message);
                    };
                },
                initSite() {
                    instance = this;
                    this.readCookie();
                    this.getServers();
                    setInterval(() => { this.sendKeepAlive() }, 5000);
                    this.connectWebsocket();
                },
                getServerIcon(server) {
                    if (server.ping >= 999) return '<span title="Server not responding">💀</span>';
                    if (server.playersIngame <= 0) return '<span title="Server is empty">💤</span>';
                    return (server.joinable ? '<span title="Server is joinable">✔️</span>' : '<span title="Server is full">✋</span>') + (server.recentlyWentJoinable ? '<span title="Recently became joinable">🛎️</span>' : '');
                },
                getTierIconUrl(mmr) {
                    if (mmr === null || mmr === "N/A") return "/images/Tier_unknown.webp";
                    if (mmr <= 300) return "/images/Tier_1.webp";
                    if (mmr <= 750) return "/images/Tier_2.webp";
                    if (mmr <= 1400) return "/images/Tier_3.webp";
                    if (mmr <= 2100) return "/images/Tier_4.webp";
                    if (mmr <= 2900) return "/images/Tier_5.webp";
                    if (mmr <= 4100) return "/images/Tier_6.webp";
                    if (mmr <= 9999) return "/images/Tier_7.webp";
                    return "/images/Tier_unknown.webp";
                },
                onRecentlyWentJoinableChanged(value, oldvalue, el, server) {
                    if (value && (value != oldvalue)) {
                        //el.classList.remove('highlight-anim');
                        //void el.offsetWidth;
                        //el.classList.add('highlight-anim');
                        if (this.soundEnabled && server.favorite) {
                            this.playSound();
                        }
                        if (server.favorite) {
                            return true;
                        }
                    }
                    return false;
                },
                filterList(item, hideEmpty) {
                    if (hideEmpty && item.playersIngame === 0) return false;
                    if (item.visibility === 1) return false;

                    return true;
                },
                playSound() {
                    var audio = new Audio('/sounds/mixkit-long-pop-2358.wav');
                    audio.play();
                    console.log("Made a sound!");
                },
                readCookie() {
                    this.hideEmpty = docCookies.hasItem('hideEmpty') ? (docCookies.getItem('hideEmpty') == 'true') : true;
                    this.soundEnabled = docCookies.hasItem('soundEnabled') ? (docCookies.getItem('soundEnabled') == 'true') : true;
                    this.favoritesOnTop = docCookies.hasItem('favoritesOnTop') ? (docCookies.getItem('favoritesOnTop') == 'true') : true;
                    this.sortKey = docCookies.hasItem('sortKey') ? docCookies.getItem('sortKey') : 'playersIngame';
                    this.sortInverse = docCookies.hasItem('sortInverse') ? (docCookies.getItem('sortInverse') == 'true') : true;
                },
                isFavorite(server) {
                    if (server.favorite) return true;
                    let key = server.hostname + ':' + server.port;
                    server.favorite = docCookies.hasItem(key) ? (docCookies.getItem(key) == 'true') : false;
                    return server.favorite;
                },
                setFavorite(server, value) {
                    server.favorite = value;
                    docCookies.setItem(server.hostname + ':' + server.port, value, (7 * 24 * 60 * 60));
                },
                getTotalPlayers(servers) {
                    return servers.map(a => a.playersIngame + a.spectators).reduce((a, b) => a + b, 0);
                },
                sortList(a, b) {
                    let res = 0;
                    if (a.favorite === b.favorite || !this.favoritesOnTop) {

                        if (this.sortKey === 'mmr') {
                            if (a[this.sortKey] === b[this.sortKey]) res = a.id - b.id;
                            else if (a[this.sortKey] === 'N/A') res = -1;
                            else if (b[this.sortKey] === 'N/A') res = 1;
                            else res = a[this.sortKey] - b[this.sortKey];
                        }
                        else if (this.sortKey === 'playersIngame') {
                            res = (a.playersIngame + a.spectators) - (b.playersIngame + b.spectators);
                        } else if (this.sortKey != 'ping' && typeof b[this.sortKey] == 'string') {
                            if (a[this.sortKey] > b[this.sortKey]) res = 1;
                            else if (a[this.sortKey] < b[this.sortKey]) res = -1;
                            else res = 0;
                        } else {
                            res = a[this.sortKey] - b[this.sortKey];
                        }
                        if (res === 0) res = a.id - b.id;
                    }
                    else if (a.favorite) return -1;
                    else if (b.favorite) return 1;

                    if (this.sortInverse) res = res * -1;
                    return res;
                },
                setSortKey(val) {
                    if (this.sortKey === val) {
                        this.sortInverse = !this.sortInverse;
                    } else {
                        this.sortKey = val;
                        this.sortInverse = true;
                        if (val === 'ping') this.sortInverse = false;
                        if (val === 'serverName') this.sortInverse = false;
                        if (val === 'mapName') this.sortInverse = false;
                    }
                    docCookies.setItem('sortKey', this.sortKey, (7 * 24 * 60 * 60));
                    docCookies.setItem('sortInverse', this.sortInverse, (7 * 24 * 60 * 60));
                }
            }
        }

    </script>
</head>

<body>
    <div class="content">
        <div class="container" x-data="alpineInstance()" x-init="initSite()" data-bs-theme="dark">
            <div class="header">
                <div class="title-block text-secondary">
                    <span class="h1 header-title" style="color: #dddddd;">NS2 Server Browser</span><span
                        class="user-select-none align-middle status-heart" x-data="{ pulse: false }"
                        x-init="$watch('heartbeat', () => { pulse = false; $nextTick(() => { pulse = true; }); });"
                        x-on:click="getServers()"
                        :class="[pulse ? 'pulse-anim' : '', connected ? '' : 'status-heart-disc']"
                        title="The heart beats when new data is received">❤️</span><br>
                    Realtime server browser for Natural Selection 2.<br>
                    Select your favorite servers with the ❤️ button to get a sound notification when there is room to
                    join
                </div>
                <div class="options-block text-secondary">
                    <!-- begin: options panel -->
                    <div class="h5">Options:</div>
                    <div class="form-check ">
                        <input class="form-check-input" type="checkbox" role="switch" id="switchEmpty"
                            x-model="hideEmpty"
                            x-init="$watch('hideEmpty', (v) => docCookies.setItem('hideEmpty', v, (7*24*60*60)))">
                        <label class="form-check-label" for="switchEmpty">Hide empty servers</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" role="switch" id="switchSound"
                            x-model="soundEnabled"
                            x-init="$watch('soundEnabled', (v) => docCookies.setItem('soundEnabled', v, (7*24*60*60)))">
                        <label class="form-check-label" for="switchSound"
                            title="A 'pop!' sound will play when a favorite server stops being full">Enable notification
                            sound for
                            favorites</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" role="switch" id="switchFavorites"
                            x-model="favoritesOnTop"
                            x-init="$watch('favoritesOnTop', (v) => docCookies.setItem('favoritesOnTop', v, (7*24*60*60)))">
                        <label class="form-check-label" for="switchFavorites">Favorites always on top</label>
                    </div>
                    <!-- end: options panel -->
                </div>
            </div>
            <div class="status-info">
                Active players: <span x-text="getTotalPlayers(servers)"></span>
            </div>
            <div class="table-responsive custom-table-responsive">
                <table class="table custom-table">
                    <thead>
                        <!-- begin: server header -->
                        <tr>
                            <th scope="col" class="highlight-column"></th>
                            <th scope="col" class="status-cell"><span>Status</span></th>
                            <th scope="col" x-data="{'name': 'playersIngame'}"
                                :class="sortKey === name ? 'sort-active' : ''" @click="setSortKey(name)"
                                class="playercount-header sortable">Players</th>
                            <th scope="col" x-data="{'name': 'mmr'}" :class="sortKey === name ? 'sort-active' : ''"
                                @click="setSortKey(name)" class="mmr-header sortable">MMR</th>
                            <th scope="col" x-data="{'name': 'serverName'}"
                                :class="sortKey === name ? 'sort-active' : ''" @click="setSortKey(name)"
                                class="sortable">Name</th>
                            <th scope="col" x-data="{'name': 'mapName'}" :class="sortKey === name ? 'sort-active' : ''"
                                @click="setSortKey(name)" class="sortable">Map</th>
                            <th scope="col" x-data="{'name': 'ping'}"
                                :class="[sortKey === name ? 'sort-active' : '', showPing ? '' : 'ping-hidden']"
                                @click="setSortKey(name)" class="sortable">&nbsp;</th>
                            <th scope="col" style="pointer-events:none">Actions</th>
                        </tr>
                        <!-- end: server header -->
                    </thead>
                    <tbody>
                        <!-- begin: server card -->
                        <template
                            x-for="server in servers.filter((v) => {return filterList(v, hideEmpty);}).sort((a,b) => sortList(a, b))"
                            :key="server.id">
                            <tr class="border-black border-bottom" x-data="{'highlighttime': 0}" scope="row"
                                x-init="$watch('server.recentlyWentJoinable', (value, oldvalue) => {if(onRecentlyWentJoinableChanged(value, oldvalue, $el, server)) {highlighttime += 1; setTimeout(() => highlighttime -= 1, 10000)}})"
                                :class="[server.ping >= 999 ? 'greyout' : '', server.favorite ? 'favoriterow' : 'not-favoriterow']"
                                :style="server.ping >= 999 ? 'pointer-events:none' : ''">
                                <td class="highlight-column" :class="highlighttime >= 1 ? 'highlight-cell' : ''"></td>
                                <td class="align-middle fs-4 status-cell">
                                    <span class="icons" x-html="getServerIcon(server)"></span>
                                </td>
                                <template x-if="server.ping < 999">
                                    <td class="align-middle ">
                                        <span class="playercount fs-5 fw-normal"><!-- btn btn-secondary -->
                                            <span x-text="server.playersIngame"></span>
                                            <span class="divider-text">/</span>
                                            <span x-text="server.maxPlayers"></span>
                                            <span class="divider-text">[</span>
                                            <span x-text="server.spectators"></span>
                                            <span class="divider-text">/</span>
                                            <span x-text="server.maxSpectators"></span>
                                            <span class="divider-text">]</span>
                                        </span>
                                    </td>
                                </template>
                                <template x-if="server.ping >= 999">
                                    <td class="align-middle">
                                        <span>-</span>
                                    </td>
                                </template>
                                <td class="align-middle">
                                    <div class="tiercontainer">
                                        <img class="tierimage" :src="getTierIconUrl(server.mmr)" />
                                        <span class="tier" x-text="server.mmr" style="pointer-events:none"></span>
                                    </div>
                                </td>
                                <td class="align-middle"><span x-text="getFlagEmoji(server.countryCode)"
                                        x-bind:title="'Ping (from EU): ' + server.ping"></span> <span class="servername"
                                        x-text="server.serverName" style="pointer-events:none"></span></td>
                                <td class="align-middle"><span class="text-uppercase" x-text="server.mapName"
                                        style="pointer-events:none"></span>
                                </td>
                                <td class="align-middle" :class="showPing ? '' : 'ping-hidden'"><span
                                        x-text="server.ping" style="pointer-events:none"></span>
                                </td>
                                <td class="align-middle fs-4"><a
                                        :href="'steam://run/4920//+connect ' + server.hostname + ':' + server.port + '/'"
                                        title="Connect to server">🚀</a>
                                    <a href="#" @click="setFavorite(server, !server.favorite)"
                                        :class="server.favorite ? 'favorite' : 'not-favorite'"
                                        title="Toggle favorite">❤️</a>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <!-- end: server card -->
            </div>
            <div class="footer">
                Made by Mads. Find me at <a href="https://steamcommunity.com/id/partypoo/">Steam</a> or <a
                    href="https://discordapp.com/users/323504845099106307">Discord</a>. All source code available at <a
                    href="https://github.com/maesse/ns2ping-web">Github</a>
            </div>
        </div>
    </div>
</body>

</html>