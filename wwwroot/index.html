<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>NS2 Server Browser</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/js/cookies.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <script>
        var instance = null;

        function alpineInstance() {
            return {
                title: 'NS2 Server Browser',
                intro: 'List over servers:',
                heartbeat: true,
                hideEmpty: true,
                soundEnabled: true,
                cookie_name: 'c',
                favoritesOnTop: true,
                sortKey: 'id',
                sortInverse: false,
                servers: [],
                getServers() {
                    fetch('/servers')
                        .then(response => response.json())
                        .then(data => {
                            if (this.servers.length == data.length) {
                                for (let i = 0; i < data.length; i++) {
                                    // Copy each field if it has changed
                                    let server = this.servers.find(v => v.id == data[i].id);
                                    for (let key in data[i]) {
                                        if (server[key] !== data[i][key]) {
                                            server[key] = data[i][key];
                                        }
                                    }
                                }
                            } else {
                                data.forEach((v) => { v.favorite = this.isFavorite(v); });
                                this.servers = data;
                            }
                            this.heartbeat = !this.heartbeat;
                        });

                },
                sendKeepAlive() {
                    socket.send("ping");
                },
                connectWebsocket() {
                    var webSocketProtocol = location.protocol == "https:" ? "wss:" : "ws:";
                    var webSocketURI = webSocketProtocol + "//" + location.host + "/ws";

                    socket = new WebSocket(webSocketURI);

                    socket.onopen = function () {
                        console.log("Connected.");
                    };

                    socket.onclose = function (event) {
                        if (event.wasClean) {
                            console.log('Disconnected.');
                        } else {
                            console.log('Connection lost.'); // for example if server processes is killed
                        }
                        console.log('Code: ' + event.code + '. Reason: ' + event.reason);
                    };

                    socket.onmessage = function (event) {
                        //console.log("Data received: " + event.data);
                        let data = JSON.parse(event.data);
                        for (let i = 0; i < data.length; i++) {
                            // Copy each field if it has changed
                            let server = window.instance.servers.find(v => v.id == data[i].id);
                            if (server) {
                                // Update existing server
                                for (let key in data[i]) {
                                    if (server[key] !== data[i][key]) {
                                        server[key] = data[i][key];
                                    }
                                }
                            } else {
                                // Add server
                                window.instance.servers.push(data[i]);
                            }
                        }

                        window.instance.heartbeat = !window.instance.heartbeat;

                    };

                    socket.onerror = function (error) {
                        console.log("Error: " + error.message);
                    };
                },
                startTimer() {
                    instance = this;
                    this.getServers();
                    //setInterval(() => { this.getServers() }, 1000);
                    setInterval(() => { this.sendKeepAlive() }, 5000);
                    this.connectWebsocket();
                },
                getServerIcon(server) {
                    if (server.ping >= 999) return '💀';
                    if (server.playersIngame <= 0) return '💤';
                    return (server.joinable ? '✔️' : '✋') + (server.recentlyWentJoinable ? '🛎️' : '');
                },
                getTierIconUrl(mmr) {
                    if (mmr === null || mmr === "N/A") return "/images/Tier_unknown.webp";
                    if (mmr <= 300) return "/images/Tier_1.webp";
                    if (mmr <= 750) return "/images/Tier_2.webp";
                    if (mmr <= 1400) return "/images/Tier_3.webp";
                    if (mmr <= 2100) return "/images/Tier_4.webp";
                    if (mmr <= 2900) return "/images/Tier_5.webp";
                    if (mmr <= 4100) return "/images/Tier_6.webp";
                    if (mmr <= 9999) return "/images/Tier_7.webp";
                    return "/images/Tier_unknown.webp";
                },
                onRecentlyWentJoinableChanged(value, oldvalue, el, server) {
                    if (value && (value != oldvalue)) {
                        el.classList.remove('highlight-anim');
                        void el.offsetWidth;
                        el.classList.add('highlight-anim');
                        if (value === true && oldvalue === false) {
                            if (!this.soundEnabled || server.favorite) {
                                this.playSound();
                            }
                        }
                    }
                },
                filterList(item, hideEmpty) {
                    if (hideEmpty && item.playersIngame === 0) return false;

                    return true;
                },
                playSound() {
                    var audio = new Audio('/sounds/mixkit-long-pop-2358.wav');
                    audio.play();
                    console.log("Made a sound!");
                },
                readCookie() {
                    this.hideEmpty = docCookies.hasItem('hideEmpty') ? (docCookies.getItem('hideEmpty') == 'true') : true;
                    this.soundEnabled = docCookies.hasItem('soundEnabled') ? (docCookies.getItem('soundEnabled') == 'true') : true;
                    this.favoritesOnTop = docCookies.hasItem('favoritesOnTop') ? (docCookies.getItem('favoritesOnTop') == 'true') : true;
                    this.sortKey = docCookies.hasItem('sortKey') ? docCookies.getItem('sortKey') : 'playersIngame';
                    this.sortInverse = docCookies.hasItem('sortInverse') ? (docCookies.getItem('sortInverse') == 'true') : true;
                },
                isFavorite(server) {
                    if (server.favorite) return true;
                    let key = server.hostname + ':' + server.port;
                    server.favorite = docCookies.hasItem(key) ? (docCookies.getItem(key) == 'true') : false;
                    return server.favorite;
                },
                setFavorite(server, value) {
                    server.favorite = value;
                    docCookies.setItem(server.hostname + ':' + server.port, value, (7 * 24 * 60 * 60));
                },
                sortList(a, b) {
                    let res = 0;
                    if (a.favorite === b.favorite || !this.favoritesOnTop) {

                        if (this.sortKey === 'mmr') {
                            if (a[this.sortKey] === b[this.sortKey]) res = a[this.sortKey].id - b[this.sortKey].id;
                            else if (a[this.sortKey] === 'N/A') res = -1;
                            else if (b[this.sortKey] === 'N/A') res = 1;
                            else res = a[this.sortKey] - b[this.sortKey];
                        }
                        else if (this.sortKey != 'ping' && typeof b[this.sortKey] == 'string') {
                            if (a[this.sortKey] > b[this.sortKey]) res = 1;
                            else if (a[this.sortKey] < b[this.sortKey]) res = -1;
                            else res = 0;
                        } else {
                            res = a[this.sortKey] - b[this.sortKey];
                        }
                    }
                    else if (a.favorite) return -1;
                    else if (b.favorite) return 1;

                    if (this.sortInverse) res = res * -1;
                    return res;
                },
                setSortKey(val) {
                    if (this.sortKey === val) {
                        this.sortInverse = !this.sortInverse;
                    } else {
                        this.sortKey = val;
                        this.sortInverse = true;
                        if (val === 'ping') this.sortInverse = false;
                        if (val === 'serverName') this.sortInverse = false;
                        if (val === 'mapName') this.sortInverse = false;
                    }
                    docCookies.setItem('sortKey', this.sortKey, (7 * 24 * 60 * 60));
                    docCookies.setItem('sortInverse', this.sortInverse, (7 * 24 * 60 * 60));
                }
            }
        }

    </script>
</head>

<body>
    <div class="content">
        <div class="container" x-data="alpineInstance()" x-init="startTimer()" data-bs-theme="dark">
            <div><span class="h1" style="color: #dddddd;">NS2 Server Browser</span><span
                    class="user-select-none align-middle" x-data="{pulse: false, cookie_name: 'c'}"
                    x-init="$watch('heartbeat', () => {pulse = false; $nextTick(() => {pulse=true;});}); readCookie()"
                    x-on:click="getServers(); pulse = false; $nextTick(() => {pulse=true;});"
                    :class="pulse ? 'pulse-anim' : ''"
                    style="position:absolute; width:40px; text-align:center">❤️</span></div>
            <div class="text-secondary">
                <div class="form-check  form-switch form-check-inline">
                    <input class="form-check-input" type="checkbox" role="switch" id="switchEmpty" x-model="hideEmpty"
                        x-init="$watch('hideEmpty', (v) => docCookies.setItem('hideEmpty', v, (7*24*60*60)))">
                    <label class="form-check-label" for="switchEmpty">Hide empty servers</label>
                </div>
                <div class="form-check  form-switch form-check-inline">
                    <input class="form-check-input" type="checkbox" role="switch" id="switchSound"
                        x-model="soundEnabled"
                        x-init="$watch('soundEnabled', (v) => docCookies.setItem('soundEnabled', v, (7*24*60*60)))">
                    <label class="form-check-label" for="switchSound">Enable sound only for favorites</label>
                </div>
                <div class="form-check  form-switch form-check-inline">
                    <input class="form-check-input" type="checkbox" role="switch" id="switchFavorites"
                        x-model="favoritesOnTop"
                        x-init="$watch('favoritesOnTop', (v) => docCookies.setItem('favoritesOnTop', v, (7*24*60*60)))">
                    <label class="form-check-label" for="switchFavorites">Favorites always on top</label>
                </div>
            </div>
            <div class="table-responsive custom-table-responsive">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th scope="col" x-data="{'name': 'id'}" :class="sortKey === name ? 'sort-active' : ''"
                                @click="setSortKey(name)">&nbsp;</th>
                            <th scope="col" x-data="{'name': 'playersIngame'}"
                                :class="sortKey === name ? 'sort-active' : ''" @click="setSortKey(name)">Players</th>
                            <th scope="col" x-data="{'name': 'mmr'}" :class="sortKey === name ? 'sort-active' : ''"
                                @click="setSortKey(name)">MMR</th>
                            <th scope="col" x-data="{'name': 'serverName'}"
                                :class="sortKey === name ? 'sort-active' : ''" @click="setSortKey(name)">Name</th>
                            <th scope="col" x-data="{'name': 'mapName'}" :class="sortKey === name ? 'sort-active' : ''"
                                @click="setSortKey(name)">Map</th>
                            <th scope="col" x-data="{'name': 'ping'}" :class="sortKey === name ? 'sort-active' : ''"
                                @click="setSortKey(name)">Ping</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- begin: server card -->
                        <template
                            x-for="server in servers.filter((v) => {return filterList(v, hideEmpty);}).sort((a,b) => sortList(a, b))"
                            :key="server.id">
                            <tr class="border-black border-bottom" scope="row"
                                x-init="$watch('server.recentlyWentJoinable', (value, oldvalue) => onRecentlyWentJoinableChanged(value, oldvalue, $el, server))"
                                :class="server.ping >= 999 ? 'greyout' : ''"
                                :style="server.ping >= 999 ? 'pointer-events:none' : ''">
                                <td class="align-middle fs-4">
                                    <span class="icons" x-text="getServerIcon(server)"
                                        style="pointer-events:none"></span>
                                </td>
                                <template x-if="server.ping < 999">
                                    <td class="align-middle ">
                                        <span class="btn btn-secondary fs-6 fw-normal"
                                            style="display: inline-block; width: 100%; pointer-events:none">
                                            <span x-text="server.playersIngame"></span>
                                            <span>/</span>
                                            <span x-text="server.maxPlayers"></span>
                                            <span>[</span>
                                            <span x-text="server.spectators"></span>
                                            <span>/</span>
                                            <span x-text="server.maxSpectators"></span>
                                            <span>]</span>
                                        </span>
                                    </td>
                                </template>
                                <template x-if="server.ping >= 999">
                                    <td class="align-middle">
                                        <span>-</span>
                                    </td>
                                </template>
                                <td class="align-middle">
                                    <div class="tiercontainer">
                                        <img class="tierimage" :src="getTierIconUrl(server.mmr)" />
                                        <span class="tier" x-text="server.mmr" style="pointer-events:none"></span>
                                    </div>
                                </td>
                                <td class="align-middle"><span class="fs-4" x-text="server.serverName"
                                        style="pointer-events:none"></span></td>
                                <td class="align-middle"><span class="text-uppercase" x-text="server.mapName"
                                        style="pointer-events:none"></span>
                                </td>
                                <td class="align-middle"><span x-text="server.ping" style="pointer-events:none"></span>
                                </td>
                                <td class="align-middle fs-4"><a
                                        :href="'steam://run/4920//+connect ' + server.hostname + ':' + server.port + '/'">🚀</a>
                                    <a href="#" @click="setFavorite(server, !server.favorite)"
                                        :class="server.favorite ? 'favorite' : 'not-favorite'">❤️</a>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <!-- end: server card -->
            </div>
        </div>
    </div>
</body>

</html>